trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  pythonVersion: '3.10'  # Adjust based on your project

stages:
# --------------BUILD STAGE--------------
- stage: Build
  jobs:
  - job: BuildJob
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '$(pythonVersion)'

    - script: |
        python -m venv venv
        source venv/bin/activate
        pip install -r requirements.txt
      displayName: 'Set up Python environment and install dependencies'

    - task: CopyFiles@2
      inputs:
        contents: '**'
        targetFolder: '$(Build.ArtifactStagingDirectory)'

    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)'
        artifactName: 'drop'

# --------------TEST STAGE--------------
- stage: Test
  jobs:
  - job: SecurityTest
    steps:
    - script: |
        curl -Lo snyk https://github.com/snyk/snyk/releases/download/v1.1299.0/snyk-linux
        chmod +x snyk
        ./snyk test
      displayName: 'Run Snyk Security Scan'

# --------------DEPLOYMENT STAGE--------------
- stage: Deploy
  jobs:
  - deployment: DeployToVM
    environment: 'development'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: CopyFiles@2
            inputs:
              contents: '**'
              targetFolder: '$(Build.ArtifactStagingDirectory)'

          - task: PublishBuildArtifacts@1
            inputs:
              pathToPublish: '$(Build.ArtifactStagingDirectory)'
              artifactName: 'drop'

          - script: |
              echo "Start Flask app or deploy to server here"
            displayName: 'Deploy Flask App'

# --------------POST-DEPLOYMENT SECURITY TEST (DAST)--------------
- stage: DAST_Scan
  jobs:
  - job: ZapScan
    steps:
    - script: |
        docker run -t owasp/zap2docker-stable zap-baseline.py -t http://your-deployed-site-url
      displayName: 'Run OWASP ZAP Baseline Scan'
