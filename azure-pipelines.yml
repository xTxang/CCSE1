trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  pythonVersion: '3.10'

stages:
# --------------BUILD STAGE--------------
- stage: Build
  jobs:
  - job: BuildJob
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '$(pythonVersion)'

    - script: |
        python --version
        echo "No requirements to install; proceeding."
      displayName: 'Set up Python (no dependencies to install)'

    - task: CopyFiles@2
      inputs:
        contents: '**'
        targetFolder: '$(Build.ArtifactStagingDirectory)'

    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)'
        artifactName: 'drop'

# --------------TEST STAGE--------------
- stage: Test
  jobs:
  - job: SecurityTest
    steps:
    - script: |
        curl -Lo snyk https://github.com/snyk/snyk/releases/latest/download/snyk-linux
        chmod +x snyk

        # Authenticate Snyk
        ./snyk auth $SNYK_TOKEN

        # Test dependencies listed in requirements.txt
        ./snyk test --file=requirements.txt --severity-threshold=low --json > snyk-deps-results.json || true

        # Test the actual source code for vulnerabilities
        ./snyk code test --severity-threshold=low --json > snyk-code-results.json || true
      displayName: 'Run Snyk Dependency and Code Security Scans'
      env:
        SNYK_TOKEN: $(SNYK_TOKEN)

    - publish: snyk-deps-results.json
      artifact: snyk-dependency-report
      displayName: 'Publish Snyk Dependency Report'

    - publish: snyk-code-results.json
      artifact: snyk-code-report
      displayName: 'Publish Snyk Code Report'



# --------------DEPLOYMENT STAGE--------------
- stage: Deploy
  jobs:
  - deployment: DeployToVM
    environment: 'development'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: CopyFiles@2
            inputs:
              contents: '**'
              targetFolder: '$(Build.ArtifactStagingDirectory)'

          - task: PublishBuildArtifacts@1
            inputs:
              pathToPublish: '$(Build.ArtifactStagingDirectory)'
              artifactName: 'drop'

          - script: |
              echo "Placeholder: Add your Flask app deployment command here"
            displayName: 'Deploy Flask App'

# # --------------DAST SCAN (ZAP)--------------
# - stage: DAST_Scan
#   jobs:
#   - job: ZapScan
#     steps:
#     - script: |
#         docker pull ghcr.io/zaproxy/zap-full-scan
#         docker run --network="host" ghcr.io/zaproxy/zap-full-scan -t http://localhost:5000
#       displayName: 'Run OWASP ZAP Full Scan'

